@{
    Layout = null;
}
@model Model.FlowerArrangement
<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Index</title>
    @*加载表格*@
    @Scripts.Render("~/plugins/jQuery/jquery-2.2.3.min.js")

    @Styles.Render("~/Bootstrap/css/bootstrap.css")
    @Scripts.Render("~/Bootstrap/js/bootstrap.js")

    @Styles.Render("~/Bootstrap/bootstrap-table/bootstrap-table.css")
    @Scripts.Render("~/Bootstrap/bootstrap-table/bootstrap-table.js")
    @Scripts.Render("~/Bootstrap/bootstrap-table/locale/bootstrap-table-zh-CN.min.js")
    @*加载弹出层*@
    @Scripts.Render("~/Thems/js/layer/layer.js")
    @*<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">*@
    <script src="~/Scripts/Admin/FlowerArrangement.js"></script>
    <style>
        .companyclass {
        display: block;
        height: 34px;
        padding: 6px 12px;
        font-size: 14px;
        line-height: 1.42857143;
        color: #555;
        background-color: #fff;
        background-image: none;
        border: 1px solid #ccc;
        border-radius: 4px; }
    </style>
</head>
<body>
    <div class="panel-body" style="padding-bottom:0px;">
        <div class="panel panel-default">
            <div class="panel-heading">花卉摆放位置列表</div>
            <div class="panel-body">
                <div id="formSearch" class="form-horizontal">
                    <div class="form-group" style="width:100%;height:30px;">
                        <div style="width:33%;float:left">
                            <label class="control-label col-sm-2" for="txt_search_departmentname">
                                位置：
                            </label>
                            <div class="col-sm-2">
                                <input type="text" class="form-control" id="arrangement">
                            </div>
                          </div>
                        <div style="width:33%;float:left">
                            <label class="control-label col-sm-2" for="txt_search_departmentname">
                                公司：
                            </label>
                            <select id="belongUsersId" class="companyid companyclass">
                                <option value="0"></option>
                            </select>           
                        </div>
                        <div style="width:33%;float:right">
                            <div class="col-sm-3" style="text-align:left;">
                                <button type="button" class="btn btn-default" onclick="onloadTable();">
                                    查询 <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                                </button>
                            </div>
                         </div>
                     </div>
            </div>
        </div>

        <div id="toolbar" class="btn-group">
            <button id="btn_add" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> 添加
            </button>
            <button id="btn_edit" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> 修改
            </button>
            <button id="btn_delete" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> 删除
            </button>
            <button type="button" class="btn btn-default">
                <a href="/FlowerArrangement/LownExcel"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> 下载Excel模板</a> 
            </button>
            <button type="button" class="btn btn-default" onclick="AlretAddByExcel()">
                <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span> 导入Excel
            </button>
            <button id="btn_ByExcel" type="button" class="btn btn-default" onclick="DownExcel()">
                <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span> 导出Excel
            </button>
        </div>
        <table id="tb_departments" data-reorderable-columns="true"></table>
        <div id="PhotoShowDiv"><img src="" id="ShowPhotoImg" style="max-height:500px;max-width:400px;" /></div>
    </div>
   </div>
    <script>
        var layindex = 0;
        function ShowPhotoInfo(values) {           
            parent.layer.closeAll();
           $("#ShowPhotoImg").attr("src", values);
            var layindex=parent.layer.open({
                    type: 1,
                    shade: false,
                    title: false, //不显示标题
                    content: $('#PhotoShowDiv').html(), //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
                    cancel: function () {
                        parent.layer.close(layindex);
                    }
                });
                $("#ShowPhotoImg").attr("src", "");            
        }
        //加载公司
        function onloadDropdownlist() {
            var html;
            $.ajax({
                url: "/FlowerArrangement/GetCompanyList",
                type: "get",
                dataType: "json",
                success: function (data, state) {                               
                    var companylist=data;  
                    for (var i = 0; i < companylist.length; i++) {
                        html += '<option value="' + companylist[i].Value + '">' + companylist[i].Text + '</option>';                       
                    }
                    $(".companyid").append(html);
                },
                error: function (m) { parent.layer.msg("error"); }
                
            });       
            
        }
        //导入Excel
        function AlretAddByExcel()
        {
                parent.layer.open({
                type: 2,
                title: '导入Excel',
                shadeClose: true,
                shade: 0.8,
                area: ['300px;', '250px;'],
                content: '/FlowerArrangement/AddByExcel',               
                end: function () {  //层彻底关闭后执行的回调
                    onloadTable(); 
                },
                cancel: function () {
                    parent.layer.close(layindex);
                 }
            });
        }
        //导出Excel
        function DownExcel()
        {
            var ids = "";
            var rows=$("#tb_departments").bootstrapTable('getSelections');
            for (var i = 0; i < rows.length; i++) {
                ids += rows[i].id + ",";
            }
            ids = ids.substring(0, ids.length - 1);
            var url;
            var arrangement = $("#arrangement").val();
            var belongUsersId= $("#belongUsersId").val();
           
            url = '/FlowerArrangement/DownloadExcel?ids=' + ids + '&limit=500&offset=1&arrangement=' + arrangement + '&belongUsersId=' + belongUsersId;
           
           location.href = url;

        }
        //页面初始化
        $(function () {
            onloadDropdownlist();
            onloadTable();
            $("#btn_add").click(function () {
                var layindex = parent.layer.open({
                    type: 2,
                    title: '增加',
                    shadeClose: true,
                    shade: 0.8,
                    area: ['630px;', '520px;'],
                    content: '/FlowerArrangement/Add',
                    //end: function () { //层销毁后触发的回调
                    //    onloadTable();
                    //    parent.layer.close(layindex);
                    //},
                    btn: ['确定', '取消'], btnAlign: 'c',
                    yes: function (index, layero) {
                        ///返回主页的数据，为提交做准备
                        if (layero.context.defaultView[1].CheckFrom()) {
                            //当点击‘确定’按钮的时候，获取弹出层返回的值
                            var editres = layero.context.defaultView[1].callbackdata();
                            $.ajax({
                                //dataType: "json"
                                url: "/FlowerArrangement/Add",
                                type: "post",
                                data: editres,
                                success: function (data, state) {
                                    $(".companyid").val("0");//重置查询条件
                                    onloadTable();
                                },
                                error: function (msg) { alert(msg); },
                            });
                        //
                            parent.layer.close(index); //如果设定了yes回调，需进行手工关闭
                        }
                    },
                    cancel: function () {
                        layer.close(layindex);
                    }
                });
            });
            $("#btn_edit").click(function () {
                var ids = $("#tb_departments").bootstrapTable('getSelections');
                console.log(ids);
                if (ids.length == 0) {
                    parent.layer.msg('请先选中一行');
                    return false;
                } else if (ids.length > 1) {
                    parent.layer.msg('请选中一行,不可多行同时编辑');
                    return false;
                }
                var layindex = parent.layer.open({
                    type: 2,
                    title: '修改',
                    shadeClose: true,
                    shade: 0.8,
                    area: ['630px;', '500px;'],
                    content: '/FlowerArrangement/Edit?id='+ids[0].id,
                    //end: function (){ //层彻底关闭后执行的回调
                    //    onloadTable();
                    //    parent.layer.close(layindex);
                    //},
                    btn: ['确定', '取消'], btnAlign: 'c',
                    yes: function (index, layero) {                       
                        ///返回主页的数据，为提交做准备                        
                        if (layero.context.defaultView[1].CheckFrom()) {
                            //当点击‘确定’按钮的时候，获取弹出层返回的值
                            var editres = layero.context.defaultView[1].callbackdata();
                            $.ajax({
                                //dataType: "json"
                                url: "/FlowerArrangement/Edit",
                                type: "post",
                                data: editres,
                                success: function (data, state) {
                                    $(".companyid").val("0");//重置查询条件
                                    onloadTable();
                                },
                                error: function (msg) { alert(msg); },
                            });
                            //
                            parent.layer.close(index); //如果设定了yes回调，需进行手工关闭
                        }
                    },
                    cancel: function () {
                        layer.close(layindex);
                    }
                });
            });
            $("#btn_delete").click(function () {
                var ids = $("#tb_departments").bootstrapTable('getSelections');
                if (ids.length == 0) {
                    parent.layer.msg('请先选中一行');
                    return false;
                } else if (ids.length > 1) {
                    parent.layer.msg('请选中一行,不可多行删除');
                    return false;
                }
                parent.layer.confirm('删除?', {
                    btn: ['确定', '取消'] //按钮
                }, function () {
                    $.ajax({
                        url: '/FlowerArrangement/Delete?id=' + ids[0].id,
                        async: false,
                        success: function (data) {
                            parent.layer.closeAll();
                            onloadTable();
                            // parent.layer.closeAll();
                        }
                    })

                }, function () {
                });
            });
        })
    </script>
</body>
</html>

